{% extends 'base.html' %}

{% block content %}
<style>
    :root {
        --primary-color: #3CB371;
        --hover-color: #2e8b57;
        --background-light: #f9f9f9;
        --text-dark: #333;
        --text-light: #777;
    }

    .container {
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .header {
        display: flex;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #ddd;
    }

    .header img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
    }

    .gallery {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: calc(100% - 20px);
        gap: 20px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding: 20px;
    }

    .gallery img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 8px;
        scroll-snap-align: start;
    }

    .details-section {
        padding: 20px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        padding: 20px;
        background: var(--background-light);
        margin: 20px 0;
        border-radius: 8px;
    }

    .info-item {
        text-align: center;
        padding: 10px;
    }

    .rating-section {
        padding: 20px;
    }

    .ratings-container {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding: 15px 0;
    }

    .rating-card {
        flex: 0 0 300px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .rating-form {
        max-width: 500px;
        margin: 20px auto;
        padding: 20px;
        background: var(--background-light);
        border-radius: 8px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .btn {
        background: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .btn:hover {
        background: var(--hover-color);
    }

    .contact-bar {
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 20px;
        background: var(--background-light);
    }

    .contact-link {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-dark);
        text-decoration: none;
    }

    @media (max-width: 768px) {
        .gallery img {
            height: 250px;
        }

        .header {
            flex-direction: column;
            text-align: center;
        }

        .header img {
            margin: 0 0 10px 0;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="container">
    <header class="header">
        {% if profile.logo %}
        <img src="{{ profile.logo.url }}" alt="{{ profile.user.username }}'s logo">
        {% endif %}
        <div>
            <h1>{{ listing.title }}</h1>
            <p>Hosted by {{ profile.user.username }}</p>
        </div>
    </header>

    <section class="gallery">
        {% for image in listing.images.all %}
        <img src="{{ image.image.url }}" alt="Property image {{ forloop.counter }}" loading="lazy">
        {% endfor %}
    </section>

    <section class="details-section">
        <h2>About this space</h2>
        <p>{{ listing.description }}</p>
        
        <div class="info-grid">
            <div class="info-item">
                <h3>{{ listing.guests }}</h3>
                <p>Guests</p>
            </div>
            <div class="info-item">
                <h3>{{ listing.bedrooms }}</h3>
                <p>Bedrooms</p>
            </div>
            <div class="info-item">
                <h3>{{ listing.bathrooms }}</h3>
                <p>Bathrooms</p>
            </div>
            <div class="info-item">
                <h3>{{ listing.price }}</h3>
                <p>Price per night</p>
            </div>
        </div>
    </section>

    <section class="rating-section">
        <h2>Ratings & Reviews</h2>
        <div class="ratings-container" id="ratings-container">
            {% for rating in ratings %}
            <div class="rating-card">
                <div class="rating-stars">
                    {% for _ in "x"|ljust:rating.stars %}
                    ★
                    {% endfor %}
                </div>
                <p class="rating-comment">{{ rating.comment }}</p>
                <small>– {{ rating.user.username }}</small>
            </div>
            {% endfor %}
        </div>

        <form class="rating-form" id="rating-form">
            <h3>Add Your Review</h3>
            <div class="form-group">
                <label for="stars">Rating</label>
                <select class="form-control" id="stars" name="stars" required>
                    {% for i in "12345" %}
                    <option value="{{ i }}">{{ i }} Star{{ i|pluralize }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="comment">Comment</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn">Submit Review</button>
        </form>
    </section>

    <div class="contact-bar">
        <a href="https://wa.me/{{ profile.phone_number }}" class="contact-link" target="_blank">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <a href="tel:{{ listing.phone_number }}" class="contact-link">
            <i class="fas fa-phone"></i> Call
        </a>
        <a href="mailto:{{ listing.email }}" class="contact-link">
            <i class="fas fa-envelope"></i> Email
        </a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('rating-form');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const response = await fetch("{% url 'add_rating' listing.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });

            if (response.ok) {
                const data = await response.json();
                const ratingsContainer = document.getElementById('ratings-container');
                
                const newRating = document.createElement('div');
                newRating.className = 'rating-card';
                newRating.innerHTML = `
                    <div class="rating-stars">${'★'.repeat(data.stars)}</div>
                    <p class="rating-comment">${data.comment}</p>
                    <small>– ${data.username}</small>
                `;
                
                ratingsContainer.prepend(newRating);
                form.reset();
                showToast('Review submitted successfully!');
            } else {
                showToast('Error submitting review. Please try again.', 'error');
            }
        });

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    });
</script>
{% endblock %}
